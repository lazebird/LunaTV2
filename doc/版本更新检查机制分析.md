# LunaTV 版本更新检查机制分析

## 概述

LunaTV 实现了一套完整的版本更新检查机制，通过定期从远程仓库获取最新版本信息并与当前版本进行比较，从而向用户提示可用更新。该机制包含版本检查、版本比较、UI提示和变更日志展示等完整功能。

## 核心组件与文件

### 1. 版本检查核心模块 [version_check.ts](../src/lib/version_check.ts)

这是版本更新检查机制的核心模块，包含以下主要功能：

#### 版本状态枚举
```typescript
export enum UpdateStatus {
  HAS_UPDATE = 'has_update',     // 有新版本
  NO_UPDATE = 'no_update',       // 无新版本
  FETCH_FAILED = 'fetch_failed', // 获取失败
}
```

#### 版本检查URL配置
系统配置了远程版本检查的URL地址：
```typescript
const VERSION_CHECK_URLS = [
  'https://raw.githubusercontent.com/SzeMeng76/LunaTV/refs/heads/main/VERSION.txt',
];
```

#### 主要函数

1. **`checkForUpdates()`**: 主入口函数，负责协调整个版本检查流程
   - 尝试从主要URL获取版本信息
   - 如果主要URL失败，尝试备用URL（目前配置中只有一个URL）
   - 返回版本检查状态

2. **`fetchVersionFromUrl(url)`**: 从指定URL获取版本信息
   - 设置5秒超时限制
   - 添加时间戳参数避免缓存
   - 处理网络错误和HTTP错误

3. **`compareVersions(remoteVersion)`**: 比较本地版本与远程版本
   - 解析版本号为数字数组（格式：X.Y.Z）
   - 标准化版本号到3个部分（不足部分补0）
   - 逐级比较版本号的每个部分
   - 支持回退到字符串比较（当版本号格式无效时）

### 2. 版本信息模块 [version.ts](../src/lib/version.ts)

存储当前版本信息的简单模块：
```typescript
const CURRENT_VERSION = '5.6.2';
export { CURRENT_VERSION };
```

项目根目录的 `VERSION.txt` 文件也包含相同的版本信息，用于保持一致性。

### 3. 版本面板组件 [VersionPanel.tsx](../src/components/VersionPanel.tsx)

负责展示版本信息和变更日志的UI组件：

#### 主要功能
- 显示当前版本和最新版本
- 展示详细的变更日志内容
- 区分本地变更日志和远程变更日志
- 提供版本更新状态的可视化指示

#### 变更日志获取
```typescript
const fetchRemoteChangelog = async () => {
  const response = await fetch(
    'https://raw.githubusercontent.com/SzeMeng76/LunaTV/refs/heads/main/CHANGELOG'
  );
  // 解析并设置远程变更日志
};
```

#### 变更日志解析
组件实现了完整的变更日志解析功能，支持解析以下格式：
```
## [X.Y.Z] - YYYY-MM-DD
### Added
- 新功能内容
### Changed
- 变更内容
### Fixed
- 修复内容
```

### 4. 用户菜单组件 [UserMenu.tsx](../src/components/UserMenu.tsx)

在用户界面中集成版本检查功能：

#### 版本检查集成
- 在组件初始化时自动执行版本检查
- 在用户菜单中显示版本更新状态指示器（红点/绿点）
- 提供打开版本面板的交互入口

#### 更新状态显示
```typescript
// 版本检查状态指示器
className={`w-2 h-2 rounded-full -translate-y-2 ${
  updateStatus === UpdateStatus.HAS_UPDATE
    ? 'bg-red-500'
    : updateStatus === UpdateStatus.NO_UPDATE
      ? 'bg-green-500'
      : 'bg-gray-400'
}`}
```

### 5. 登录/注册页面版本显示

在登录页面 (`src/app/login/page.tsx`) 和注册页面 (`src/app/register/page.tsx`) 中也集成了版本检查功能：

#### 版本显示组件
```typescript
function VersionDisplay() {
  const [updateStatus, setUpdateStatus] = useState<UpdateStatus | null>(null);
  
  useEffect(() => {
    const checkUpdate = async () => {
      const status = await checkForUpdates();
      setUpdateStatus(status);
    };
    checkUpdate();
  }, []);
  
  // 根据状态显示不同的版本信息
}
```

## 版本检查流程

### 1. 初始化检查
在应用启动时，以下组件会自动执行版本检查：
- 用户菜单组件 (`UserMenu`)
- 登录页面版本显示组件 (`VersionDisplay`)
- 注册页面版本显示组件 (`VersionDisplay`)

### 2. 检查流程
1. **获取远程版本**: 从配置的GitHub URL获取最新版本号
2. **版本比较**: 使用 `compareVersions()` 函数比较本地和远程版本
3. **状态更新**: 根据比较结果设置 `UpdateStatus`
4. **UI更新**: 根据状态更新用户界面显示

### 3. 版本比较逻辑
版本比较采用逐级比较的方式：
1. 将版本号解析为数字数组 [X, Y, Z]
2. 标准化版本号到3个部分（不足补0）
3. 依次比较主版本号、次版本号、修订版本号
4. 只要远程版本任一部分大于本地版本，即认为有更新

## 错误处理机制

### 1. 网络错误处理
- 设置5秒超时限制
- 捕获网络异常并返回 `FETCH_FAILED` 状态
- 提供备用URL支持（目前未完全实现）

### 2. 版本格式错误处理
- 捕获版本号解析异常
- 回退到字符串比较方式
- 记录错误日志便于调试

### 3. UI错误处理
- 在获取失败时显示适当的错误状态
- 避免因版本检查失败影响主要功能

## 用户体验优化

### 1. 缓存避免
- 在版本检查URL中添加时间戳参数，避免浏览器缓存
- 确保每次检查都能获取最新的版本信息

### 2. 异步加载
- 版本检查采用异步方式，不阻塞页面加载
- 在检查过程中显示加载状态

### 3. 视觉反馈
- 使用不同颜色的指示器显示版本状态
- 在用户菜单中提供明显的更新提示
- 版本面板中详细展示变更内容

## 配置与扩展性

### 1. URL配置
版本检查URL配置在 `VERSION_CHECK_URLS` 常量中，可以轻松添加备用URL：
```typescript
const VERSION_CHECK_URLS = [
  'https://raw.githubusercontent.com/SzeMeng76/LunaTV/refs/heads/main/VERSION.txt',
  // 可以添加备用URL
  'https://backup-url.com/VERSION.txt',
];
```

### 2. 检查间隔
目前版本检查在应用启动时执行，可以考虑添加定期检查功能：
```typescript
// 可以添加定期检查逻辑
setInterval(async () => {
  const status = await checkForUpdates();
  setUpdateStatus(status);
}, 24 * 60 * 60 * 1000); // 每24小时检查一次
```

## 安全考虑

### 1. HTTPS使用
所有版本检查URL使用HTTPS协议，确保传输安全。

### 2. 超时控制
设置5秒超时限制，避免长时间等待影响用户体验。

### 3. 内容验证
对获取的版本内容进行验证，确保格式正确。

## 总结

LunaTV的版本更新检查机制设计完善，具有以下特点：

1. **完整性**: 包含版本检查、比较、UI展示和变更日志等完整功能
2. **可靠性**: 具备错误处理和超时控制机制
3. **用户友好**: 提供清晰的视觉反馈和详细的变更信息
4. **可扩展性**: 易于添加备用URL和修改检查策略
5. **性能优化**: 采用异步加载和缓存避免策略

该机制为用户提供了便捷的版本更新感知能力，有助于用户及时获取最新功能和安全修复。