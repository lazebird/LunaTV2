# LunaTV 后端功能分析报告

## 概述

LunaTV 是基于 Next.js 14 构建的全栈视频聚合应用，具备完整的后端 API 功能。本报告详细分析了项目的后端功能特性、API 接口以及部署支持情况。

## 项目架构

### 技术栈
- **框架**: Next.js 14 (App Router)
- **运行时**: Node.js (支持 Edge Runtime)
- **部署模式**: Standalone 输出
- **PWA 支持**: 通过 next-pwa 实现
- **缓存策略**: 多层级缓存（内存/Redis/Upstash/localStorage）

### 部署配置
```javascript
// next.config.js
output: 'standalone'  // 支持独立部署
experimental: {
  instrumentationHook: process.env.NODE_ENV === 'production'
}
```

## 后端功能模块

### 1. 用户认证与授权

#### API 接口
- `POST /api/login` - 用户登录
- `POST /api/logout` - 用户登出
- `POST /api/register` - 用户注册
- `POST /api/change-password` - 修改密码

#### 功能特性
- 多种认证模式支持（localStorage/数据库）
- 基于 Cookie 的会话管理
- HMAC 签名验证
- 角色权限控制（owner/admin/user）
- Telegram 集成认证

#### 存储模式适配
```javascript
// localStorage 模式：单密码验证
if (STORAGE_TYPE === 'localstorage') {
  // 环境变量 PASSWORD 验证
}

// 数据库模式：多用户支持
else {
  // 用户名密码数据库验证
}
```

### 2. 搜索与内容聚合

#### API 接口
- `GET /api/search` - 主搜索接口
- `GET /api/search/suggestions` - 搜索建议
- `GET /api/search/resources` - 资源搜索
- `GET /api/search/one` - 单一搜索
- `GET /api/search/ws` - WebSocket 搜索

#### 功能特性
- 多源并行搜索
- 智能超时控制（20秒）
- 内容过滤（成人内容过滤）
- 缓存优化
- 错误容错处理

#### 缓存策略
```javascript
headers: {
  'Cache-Control': `public, max-age=${cacheTime}, s-maxage=${cacheTime}`,
  'CDN-Cache-Control': `public, s-maxage=${cacheTime}`,
  'Vercel-CDN-Cache-Control': `public, s-maxage=${cacheTime}`
}
```

### 3. 内容管理

#### 视频内容 API
- `GET /api/detail` - 视频详情
- `GET /api/parse` - 内容解析
- `GET /api/sources` - 资源列表

#### 豆瓣集成
- `GET /api/douban/*` - 豆瓣数据接口
- `GET /api/douban/categories` - 分类
- `GET /api/douban/details` - 详情
- `GET /api/douban/recommends` - 推荐

#### 短剧内容
- `GET /api/shortdrama/*` - 短剧相关接口
- `GET /api/shortdrama/list` - 短剧列表
- `GET /api/shortdrama/detail` - 短剧详情
- `GET /api/shortdrama/search` - 短剧搜索

### 4. 用户数据管理

#### 播放记录
- `GET /api/playrecords` - 获取播放记录
- `POST /api/playrecords` - 保存播放记录
- `DELETE /api/playrecords` - 删除播放记录

#### 收藏功能
- `GET /api/favorites` - 获取收藏
- `POST /api/favorites` - 添加收藏
- `DELETE /api/favorites` - 删除收藏

#### 搜索历史
- `GET /api/searchhistory` - 搜索历史
- `POST /api/searchhistory` - 添加历史
- `DELETE /api/searchhistory` - 删除历史

#### 跳过配置
- `GET /api/skipconfigs` - 跳过配置
- `GET /api/episode-skip-config` - 剧集跳过配置

### 5. 管理功能

#### 站点管理
- `GET /api/admin/*` - 管理员接口组
- `GET /api/admin/config` - 配置管理
- `GET /api/admin/user` - 用户管理
- `GET /api/admin/source` - 资源管理
- `GET /api/admin/cache` - 缓存管理
- `GET /api/admin/play-stats` - 播放统计

#### 数据迁移
- `GET /api/admin/data_migration/export` - 数据导出
- `GET /api/admin/data_migration/import` - 数据导入

#### AI 推荐
- `GET /api/admin/ai-recommend` - AI 推荐配置
- `GET /api/ai-recommend` - AI 推荐接口

### 6. 代理服务

#### 媒体代理
- `GET /api/proxy/m3u8` - M3U8 代理
- `GET /api/proxy/segment` - 视频片段代理
- `GET /api/proxy/logo` - Logo 代理
- `GET /api/image-proxy` - 图片代理

#### 工具代理
- `GET /api/proxy/spider.jar` - Spider Jar 代理
- `GET /api/proxy/key` - 密钥代理

### 7. 直播功能

#### 直播接口
- `GET /api/live/*` - 直播相关接口
- `GET /api/live/channels` - 频道列表
- `GET /api/live/epg` - EPG 数据
- `GET /api/live/merged` - 合并数据
- `GET /api/live/sources` - 直播源

### 8. TVBox 集成

#### TVBox 接口
- `GET /api/tvbox/*` - TVBox 相关接口
- `GET /api/tvbox/search` - TVBox 搜索
- `GET /api/tvbox/health` - 健康检查
- `GET /api/tvbox/diagnose` - 诊断接口
- `GET /api/tvbox-config` - 配置接口

### 9. 第三方集成

#### YouTube
- `GET /api/youtube/search` - YouTube 搜索

#### Telegram
- `GET /api/telegram/*` - Telegram 集成
- `POST /api/telegram/webhook` - Webhook
- `GET /api/telegram/send-magic-link` - 魔法链接

#### TMDB
- `GET /api/tmdb/actor` - TMDB 演员信息

### 10. 工具类接口

#### 缓存管理
- `GET /api/cache` - 缓存获取
- `POST /api/cache` - 缓存设置
- `DELETE /api/cache` - 缓存删除

#### 系统工具
- `GET /api/cron` - 定时任务
- `GET /api/server-config` - 服务器配置
- `GET /api/bing-wallpaper` - Bing 壁纸

## 静态页面部署支持

### Next.js 静态导出限制

**当前项目不支持完全静态部署**，原因如下：

1. **大量 API 路由** - 89个 API 接口需要服务端运行
2. **数据库依赖** - 用户认证、数据存储需要后端支持
3. **代理功能** - 媒体代理需要服务端转发
4. **实时功能** - 搜索、解析需要实时请求

### 部署方式分析

#### 1. 服务器部署（推荐）
```bash
# 构建独立版本
npm run build

# 运行生产服务器
npm start
```

**优势：**
- 完整功能支持
- 性能最佳
- 所有后端功能可用

**适用场景：**
- VPS 服务器
- 云服务器（阿里云、腾讯云等）
- Docker 容器部署

#### 2. Vercel 部署（无服务器）
```json
// vercel.json
{
  "crons": [
    {
      "path": "/api/cron",
      "schedule": "0 1 * * *"
    }
  ]
}
```

**优势：**
- 零配置部署
- 自动扩展
- 全球 CDN

**限制：**
- 函数执行时间限制
- 部分功能可能受限
- 成本随使用量增加

#### 3. 静态化改造方案

如需支持静态部署，需要以下改造：

1. **API 外部化** - 将 API 迁移到外部服务
2. **数据存储改造** - 使用客户端存储方案
3. **代理功能移除** - 无法在静态环境使用代理
4. **搜索接口改造** - 使用前端搜索或外部 API

**改造后的功能损失：**
- 用户认证功能
- 数据持久化
- 代理服务
- 管理功能
- 统计功能

## 性能优化

### 缓存策略

#### 多层缓存架构
```
浏览器缓存 -> CDN 缓存 -> API 缓存 -> 数据库缓存
```

#### 缓存控制
```javascript
// 动态缓存时间
const cacheTime = await getCacheTime();

// 多级缓存头
'Cache-Control': `public, max-age=${cacheTime}, s-maxage=${cacheTime}`
'CDN-Cache-Control': `public, s-maxage=${cacheTime}`
'Vercel-CDN-Cache-Control': `public, s-maxage=${cacheTime}`
```

### 数据库优化

#### 连接管理
- Redis 连接池
- 自动重连机制
- 操作重试策略

#### 查询优化
- 批量操作
- 键模式优化
- TTL 管理

## 安全特性

### 认证安全
- HMAC 签名验证
- 时间戳防重放
- Cookie 安全配置
- 角色权限控制

### 内容安全
- 成人内容过滤
- 敏感词过滤
- URL 参数验证

### 网络安全
- CORS 配置
- 请求头验证
- 超时控制

## 扩展性设计

### 存储抽象
```javascript
// 统一存储接口
interface IStorage {
  getPlayRecord(): Promise<PlayRecord>
  setPlayRecord(): Promise<void>
  // ... 其他方法
}
```

### 模块化架构
- 功能模块独立
- 插件化设计
- 配置驱动

### 多环境支持
- 开发/生产环境适配
- 存储模式切换
- 功能开关控制

## 监控与日志

### 错误处理
```javascript
try {
  // 业务逻辑
} catch (error) {
  console.error('操作失败:', error);
  return NextResponse.json({ error: '操作失败' }, { status: 500 });
}
```

### 日志记录
- 请求日志
- 错误日志
- 性能日志
- 用户行为日志

## 总结

LunaTV 具备完整的后端功能，包含用户管理、内容聚合、数据存储、代理服务等全面的功能模块。项目采用 Next.js 全栈架构，支持多种部署方式，但**不支持完全静态部署**。

### 推荐部署方案

1. **生产环境** - VPS/云服务器部署
2. **快速体验** - Vercel 无服务器部署
3. **开发测试** - 本地开发服务器

### 功能完整性

- ✅ 用户认证与授权
- ✅ 内容搜索与聚合
- ✅ 数据持久化
- ✅ 代理服务
- ✅ 管理功能
- ✅ 第三方集成
- ❌ 静态页面部署

项目架构设计合理，扩展性良好，适合作为视频聚合平台的基础框架。