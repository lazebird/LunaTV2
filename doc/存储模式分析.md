# LunaTV 存储模式详细分析

## 概述

LunaTV 项目支持多种存储模式，以适应不同的部署环境和需求。本文档详细分析了各种存储模式的实现、优缺点和适用场景。

## 支持的存储模式

项目目前支持以下四种存储模式：

1. **localStorage** - 浏览器本地存储
2. **Redis** - 标准 Redis 数据库
3. **Upstash** - 基于 Redis 的云数据库服务
4. **KVRocks** - 分布式 Redis 兼容存储

## 存储模式配置

存储模式通过环境变量 `NEXT_PUBLIC_STORAGE_TYPE` 进行配置：

```bash
# 默认使用 localStorage
NEXT_PUBLIC_STORAGE_TYPE=localstorage

# 使用标准 Redis
NEXT_PUBLIC_STORAGE_TYPE=redis
REDIS_URL=redis://localhost:6379

# 使用 Upstash Redis
NEXT_PUBLIC_STORAGE_TYPE=upstash
UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
UPSTASH_REDIS_REST_TOKEN=xxx

# 使用 KVRocks
NEXT_PUBLIC_STORAGE_TYPE=kvrocks
KVROCKS_URL=redis://localhost:6666
```

## 各存储模式详细分析

### 1. localStorage 模式

#### 实现细节
- 基于浏览器原生 localStorage API
- 数据直接存储在用户浏览器中
- 实现位置：`src/lib/db.client.ts`

#### 优缺点

**优点：**
- 零配置，无需部署数据库
- 访问速度极快，无网络延迟
- 数据完全本地化，隐私性好
- 适合个人使用或演示环境

**缺点：**
- 数据仅限单机使用，更换浏览器或设备会丢失
- 存储容量有限（通常 5-10MB）
- 无法支持多用户数据共享
- 不支持服务端数据处理和统计

#### 适用场景
- 个人使用或测试环境
- 演示或原型开发
- 对数据持久性要求不高的场景
- 无法部署数据库的受限环境

#### 数据结构
```javascript
// 播放记录
moontv_play_records: { "source+id": PlayRecord }

// 收藏夹
moontv_favorites: { "source+id": Favorite }

// 搜索历史
moontv_search_history: ["keyword1", "keyword2", ...]

// 跳过配置
moontv_skip_configs: { "source+id": SkipConfig }
```

### 2. Redis 模式

#### 实现细节
- 基于标准 Redis 服务器
- 使用 Redis 客户端库 (`redis` v4.6.7)
- 实现位置：`src/lib/redis.db.ts` 和 `src/lib/redis-base.db.ts`
- 支持连接重试和自动重连机制

#### 优缺点

**优点：**
- 高性能，内存存储，访问速度快
- 支持数据持久化（RDB/AOF）
- 支持丰富的数据结构
- 支持集群部署和横向扩展
- 完整的统计功能和数据分析

**缺点：**
- 需要单独部署和维护 Redis 服务器
- 内存成本较高，大数据量时费用增加
- 需要配置 Redis 连接参数
- 需要处理网络连接和故障恢复

#### 适用场景
- 生产环境部署
- 需要多用户数据共享
- 需要数据统计和分析功能
- 对性能要求较高的应用
- 已有 Redis 基础设施的环境

#### 数据结构
```redis
# 播放记录
u:{username}:pr:{source+id} -> PlayRecord JSON

# 收藏夹
u:{username}:fav:{source+id} -> Favorite JSON

# 搜索历史（列表）
u:{username}:sh -> [keyword1, keyword2, ...]

# 跳过配置
u:{username}:skip:{source+id} -> SkipConfig JSON

# 用户密码
u:{username}:pwd -> password

# 管理员配置
admin:config -> AdminConfig JSON

# 缓存数据
cache:{key} -> data JSON (带 TTL)
```

### 3. Upstash 模式

#### 实现细节
- 基于 Upstash Redis 云服务
- 使用 `@upstash/redis` 客户端库
- 实现位置：`src/lib/upstash.db.ts`
- 通过 HTTP API 访问，无需直接连接 Redis

#### 优缺点

**优点：**
- 完全托管，无需自建 Redis 服务器
- 按需付费，成本可控
- 全球分布式部署，访问延迟低
- 自动备份和故障恢复
- 支持无服务器架构

**缺点：**
- 依赖第三方服务，存在供应商锁定风险
- 网络访问可能存在延迟
- 免费额度有限，大规模使用成本较高
- 数据存储在第三方平台

#### 适用场景
- 无服务器部署（Vercel、Netlify 等）
- 快速原型开发和 MVP
- 不想维护基础设施的团队
- 需要全球分布式访问的应用
- 中小规模生产环境

#### 配置要求
```bash
# Upstash Redis REST API 配置
UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
UPSTASH_REDIS_REST_TOKEN=xxx
```

### 4. KVRocks 模式

#### 实现细节
- 基于 KVRocks（分布式 Redis 兼容存储）
- 继承自 `BaseRedisStorage` 基类
- 实现位置：`src/lib/kvrocks.db.ts`
- 使用标准 Redis 客户端连接

#### 优缺点

**优点：**
- Redis 协议兼容，无需修改应用代码
- 支持磁盘存储，成本更低
- 适合大规模数据存储
- 支持分布式部署
- 高可用性和数据持久性

**缺点：**
- 需要部署和维护 KVRocks 集群
- 相比纯 Redis，写入性能略低
- 社区生态相对较小
- 需要专业知识进行运维

#### 适用场景
- 大规模数据存储需求
- 成本敏感的生产环境
- 需要 Redis 兼容性但数据量较大的场景
- 已有 KVRocks 基础设施的环境

## 存储模式对比

| 特性 | localStorage | Redis | Upstash | KVRocks |
|------|-------------|-------|---------|---------|
| 部署复杂度 | 无需部署 | 中等 | 无需部署 | 复杂 |
| 数据持久性 | 差 | 好 | 好 | 极好 |
| 多用户支持 | 不支持 | 支持 | 支持 | 支持 |
| 数据统计功能 | 不支持 | 完整支持 | 完整支持 | 完整支持 |
| 访问速度 | 极快 | 快 | 中等 | 快 |
| 存储容量 | 有限 | 取决于内存 | 按需扩展 | 大容量 |
| 成本 | 免费 | 服务器成本 | 按使用付费 | 服务器成本 |
| 维护需求 | 无 | 需要维护 | 无需维护 | 需要维护 |
| 数据共享 | 不支持 | 支持 | 支持 | 支持 |
| 扩展性 | 无 | 水平扩展 | 自动扩展 | 水平扩展 |

## 混合存储策略

项目实现了智能的混合存储策略，在不同模式下自动适配：

### localStorage 模式的增强
- 在 localStorage 模式下，系统仍然会尝试使用数据库缓存
- 如果数据库不可用，自动回退到 localStorage
- 提供数据迁移工具，可以导出/导入数据

### 数据库模式的兜底机制
- 所有数据库模式都包含 localStorage 兜底
- 当数据库连接失败时，自动使用 localStorage
- 数据恢复后，可以手动同步数据

### 内存缓存优化
- 在非 localStorage 模式下，使用内存缓存减少 localStorage 访问
- 避免 QuotaExceededError 错误
- 提高大量数据场景下的性能

## 数据迁移方案

### 从 localStorage 迁移到数据库
```javascript
// 管理员面板中的数据导出/导入功能
// 位置：src/components/DataMigration.tsx
```

### 数据备份和恢复
- Redis 模式：使用 Redis 原生的 BGSAVE 和 RESTORE
- Upstash 模式：通过控制台备份
- KVRocks 模式：使用快照功能

## 推荐选择指南

### 个人使用或测试
**推荐：localStorage**
- 零配置，开箱即用
- 数据本地化，隐私性好
- 适合个人观影记录管理

### 小团队或初创公司
**推荐：Upstash**
- 无需维护基础设施
- 按需付费，成本可控
- 支持快速迭代和扩展

### 中大型企业
**推荐：Redis/KVRocks**
- 完全控制数据和基础设施
- 支持大规模用户和数据
- 可根据成本和性能需求选择

### 特殊需求场景
- **无服务器部署**：Upstash
- **大规模数据存储**：KVRocks
- **已有 Redis 基础设施**：Redis
- **离线或内网环境**：Redis 或 KVRocks

## 性能优化建议

### Redis 模式优化
1. 配置合适的内存策略（maxmemory-policy）
2. 启用持久化（RDB + AOF）
3. 配置集群模式提高可用性
4. 监控内存使用情况

### Upstash 模式优化
1. 合理设置 TTL 避免存储过多数据
2. 使用批量操作减少 API 调用
3. 监控 API 使用量控制成本

### KVRocks 模式优化
1. 配置合适的压缩算法
2. 调整内存和磁盘比例
3. 配置副本集提高可用性

## 安全考虑

### 数据加密
- 密码存储：目前使用明文存储，生产环境建议加密
- 传输安全：使用 HTTPS/TLS 加密传输
- 访问控制：配置 Redis 密码认证

### 隐私保护
- localStorage 模式数据完全本地化
- 数据库模式需要配置访问权限
- 定期备份重要数据

## 未来发展方向

### 可能的改进
1. 支持更多数据库（如 MongoDB、PostgreSQL）
2. 实现数据同步和备份策略
3. 添加数据压缩和加密功能
4. 支持多数据中心部署

### 新功能规划
1. 数据分析和报表功能
2. 用户行为追踪
3. 智能推荐系统
4. 数据导出格式扩展

## 总结

LunaTV 的多存储模式设计为不同用户和场景提供了灵活的选择。从简单的个人使用到企业级部署，都有合适的存储方案。选择合适的存储模式需要考虑部署复杂度、成本、性能和数据持久性等多个因素。

通过智能的混合存储策略和兜底机制，系统确保在各种环境下都能稳定运行，为用户提供良好的使用体验。